<!doctype html>
<html class="no-js" lang="">

<head>
    <meta charset="utf-8">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>webapp</title>
    <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
    <!-- build:css styles/vendor.css -->
    <!-- bower:css -->
    <!-- endbower -->
    <!-- endbuild -->
    <!-- build:css styles/main.css -->
<!--    <link rel="stylesheet" href="styles/main.css">-->
    <link rel="stylesheet" href="styles/bootstrap.css">
    <link rel="stylesheet" href="/bower_components/datatables/media/css/jquery.dataTables.css">
    <link rel="stylesheet" href="/bower_components/datatables/media/css/jquery.dataTables_themeroller.css">
    <link rel="stylesheet" href="/bower_components/bootstrap-modal/css/bootstrap-modal.css">
    <link rel="stylesheet" href="/bower_components/bootstrap-modal/css/bootstrap-modal-bs3patch.css">
    <style>
        html,
        body,
        #map-canvas {
            height: 100%;
            margin: 0px;
            padding: 0px
        }
        .tt-query {
  -webkit-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075);
     -moz-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075);
          box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075);
}

.tt-hint {
  color: #999
}

.tt-menu {
  width: 422px;
  margin: 12px 0;
  padding: 8px 0;
  background-color: #fff;
  border: 1px solid #ccc;
  border: 1px solid rgba(0, 0, 0, 0.2);
  -webkit-border-radius: 8px;
     -moz-border-radius: 8px;
          border-radius: 8px;
  -webkit-box-shadow: 0 5px 10px rgba(0,0,0,.2);
     -moz-box-shadow: 0 5px 10px rgba(0,0,0,.2);
          box-shadow: 0 5px 10px rgba(0,0,0,.2);
}

.tt-suggestion {
  padding: 3px 20px;
  font-size: 18px;
  line-height: 24px;
}

.tt-suggestion:hover {
  cursor: pointer;
  color: #fff;
  background-color: #0097cf;
}

.tt-suggestion.tt-cursor {
  color: #fff;
  background-color: #0097cf;

}

.tt-suggestion p {
  margin: 0;
}
    </style>
    <!-- endbuild -->
    <!-- build:js scripts/vendor/modernizr.js -->
    <script src="/bower_components/modernizr/modernizr.js"></script>
    <!-- endbuild -->
</head>

<body>
    <!--[if lt IE 10]>
            <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->
    <div class="container">
        <nav class="navbar navbar-default">
            <div class="container-fluid">
                <!-- Brand and toggle get grouped for better mobile display -->
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="#">IDLog</a>
                </div>
                <!-- Collect the nav links, forms, and other content for toggling -->
                <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                    <ul class="nav navbar-nav">
                        <li><a href="/input">Home</a>
                        <li><a href="/list">Archive</a>
                        </li>                    
                    </ul>
                    <form class="navbar-form navbar-left" role="search">
                        <div class="form-group">
                            <input id='inpSearch' type="text" class="form-control" placeholder="Search">
                        </div>
                        <button type="submit" class="btn btn-default">Submit</button>
                    </form>
                    <ul class="nav navbar-nav">
                        <li><a id='liLogin' href="/login">login/logout</a>
                        </li>
                    </ul>
                </div>
                <!-- /.navbar-collapse -->
            </div>
            <!-- /.container-fluid -->
        </nav>
        <div class="jumbotron">
            <div class="">
                <img class="center-block img-circle" id="idPhoto" alt="140x140" src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9InllcyI/PjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTQwIiBoZWlnaHQ9IjE0MCIgdmlld0JveD0iMCAwIDE0MCAxNDAiIHByZXNlcnZlQXNwZWN0UmF0aW89Im5vbmUiPjxkZWZzLz48cmVjdCB3aWR0aD0iMTQwIiBoZWlnaHQ9IjE0MCIgZmlsbD0iI0VFRUVFRSIvPjxnPjx0ZXh0IHg9IjQ1LjUiIHk9IjcwIiBzdHlsZT0iZmlsbDojQUFBQUFBO2ZvbnQtd2VpZ2h0OmJvbGQ7Zm9udC1mYW1pbHk6QXJpYWwsIEhlbHZldGljYSwgT3BlbiBTYW5zLCBzYW5zLXNlcmlmLCBtb25vc3BhY2U7Zm9udC1zaXplOjEwcHQ7ZG9taW5hbnQtYmFzZWxpbmU6Y2VudHJhbCI+MTQweDE0MDwvdGV4dD48L2c+PC9zdmc+" data-holder-rendered="true" style="width: 140px; height: 140px;">
            </div>
        </div>
        <div class="row">
            <form role="form" id='eidForm' method="post" action="/"> 
                <div class="row">
                    <div class="col-xs-12 col-sm-4 col-md-4">
                        <div class="form-group">
                            <input type="text" name="firstName" id="firstName" class="form-control input-sm" placeholder="First Name" required>
                        </div>
                    </div>
                    <div class="col-xs-12 col-sm-4 col-md-4">
                        <div class="form-group">
                            <input type="text" name="middleName" id="middleName" class="form-control input-sm" placeholder="Middle Name">
                        </div>
                    </div>
                    <div class="col-xs-12 col-sm-4 col-md-4">
                        <div class="form-group">
                            <input type="text" name="name" id="name" class="form-control input-sm" placeholder="Last Name" required>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <input type="email" name="email" id="email" class="form-control input-sm" placeholder="Email Address" required>
                </div>
                <div class="form-group">
                    <input type="text" name="nationality" id="nationality" class="form-control input-sm" placeholder="Nationality" required>
                </div>
                <div class="row">
                    <div class="col-xs-12 col-sm-6 col-md-6">
                        <div class="form-group">
                            <input type="text" name="nationalNumber" id="nationalNumber" class="form-control input-sm" placeholder="National number" required>
                        </div>
                    </div>
                    <div class="col-xs-12 col-sm-6 col-md-6">
                        <div class="form-group">
                            <input type="text" name="cardNumber" id="cardNumber" class="form-control input-sm" placeholder="Card number" required>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-12 col-sm-6 col-md-6">
                        <div class="form-group">
                            <input type="text" name="placeOfBirth" id="placeOfBirth" class="form-control input-sm" placeholder="Place of birth" required>
                        </div>
                    </div>
                    <div class="col-xs-12 col-sm-6 col-md-6">
                        <div class="form-group">
                            <input type="text" name="dateOfBirth" id="dateOfBirth" class="form-control input-sm" placeholder="Date of birth" required>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-12 col-sm-4 col-md-4">
                        <div class="form-group">
                            <input type="text" name="streetAndNumber" id="streetAndNumber" class="form-control input-sm" placeholder="Street and number" required>
                        </div>
                    </div>
                    <div class="col-xs-12 col-sm-4 col-md-4">
                        <div class="form-group">
                            <input type="text" name="zip" id="zip" class="form-control input-sm" placeholder="Zip code" required>
                        </div>
                    </div>
                    <div class="col-xs-12 col-sm-4 col-md-4">
                        <div class="form-group">
                            <input type="text" name="municipality" id="municipality" class="form-control input-sm" placeholder="Municipality" required>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-12 col-sm-6 col-md-6">
                        <div class="form-group">
                            <input disabled="true" type="text" name="cardValidityDateBegin" id="cardValidityDateBegin" class="form-control input-sm" placeholder="Card validity begin date">
                        </div>
                    </div>
                    <div class="col-xs-12 col-sm-6 col-md-6">
                        <div class="form-group">
                            <input disabled="true" type="text" name="cardValidityDateEnd" id="cardValidityDateEnd" class="form-control input-sm" placeholder="Card validity end date">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-12 col-sm-6 col-md-6">
                        <div class="form-group">
                            <button type="button" id="btnReadId" class="btn btn-info btn-block">Lees E-Id</button>
                        </div>
                    </div>
                    <div class="col-xs-12 col-sm-6 col-md-6">
                        <div class="form-group">
                            <input type="submit" id="btnOpslaan" value="Gegevens opslaan" class="btn btn-info btn-block">
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="footer">
            <p>IDLog team</p>
        </div>
    </div>
    <div id="map-canvas"></div>
    <!-- Google Analytics: change UA-XXXXX-X to be your site's ID. -->
    <script>
        (function (b, o, i, l, e, r) {
            b.GoogleAnalyticsObject = l;
            b[l] || (b[l] =
                function () {
                    (b[l].q = b[l].q || []).push(arguments)
                });
            b[l].l = +new Date;
            e = o.createElement(i);
            r = o.getElementsByTagName(i)[0];
            e.src = '//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e, r)
        }(window, document, 'script', 'ga'));
        ga('create', 'UA-XXXXX-X');
        ga('send', 'pageview');
    </script>
    <!-- build:js scripts/vendor.js -->
    <!-- bower:js -->
    <script src="/bower_components/modernizr/modernizr.js"></script>
    <script src="/bower_components/jquery/dist/jquery.js"></script>
    <script src="/bower_components/json3/lib/json3.js"></script>
    <script src="/bower_components/jquery.cookie/jquery.cookie.js"></script>   
    <script src="/bower_components/datatables/media/js/jquery.dataTables.js"></script>
    <script src="scripts/bootstrap.js"></script>
    <script src="/bower_components/bootstrap-modal/js/bootstrap-modalmanager.js"></script>
    <script src="/bower_components/bootstrap-modal/js/bootstrap-modal.js"></script>
        <script src="/bower_components/typeahead.js/dist/typeahead.bundle.js"></script>
    <!-- endbower -->
    <!-- endbuild -->
    <!-- build:js scripts/plugins.js -->
<!--
    <script src="/bower_components/bootstrap-sass-official/assets/javascripts/bootstrap/affix.js"></script>
    <script src="/bower_components/bootstrap-sass-official/assets/javascripts/bootstrap/alert.js"></script>
    <script src="/bower_components/bootstrap-sass-official/assets/javascripts/bootstrap/dropdown.js"></script>
    <script src="/bower_components/bootstrap-sass-official/assets/javascripts/bootstrap/tooltip.js"></script>
    <script src="/bower_components/bootstrap-sass-official/assets/javascripts/bootstrap/modal.js"></script>
    <script src="/bower_components/bootstrap-sass-official/assets/javascripts/bootstrap/transition.js"></script>
    <script src="/bower_components/bootstrap-sass-official/assets/javascripts/bootstrap/button.js"></script>
    <script src="/bower_components/bootstrap-sass-official/assets/javascripts/bootstrap/popover.js"></script>
    <script src="/bower_components/bootstrap-sass-official/assets/javascripts/bootstrap/carousel.js"></script>
    <script src="/bower_components/bootstrap-sass-official/assets/javascripts/bootstrap/scrollspy.js"></script>
    <script src="/bower_components/bootstrap-sass-official/assets/javascripts/bootstrap/collapse.js"></script>
    <script src="/bower_components/bootstrap-sass-official/assets/javascripts/bootstrap/tab.js"></script>

-->
    <!-- endbuild -->
    <!-- build:js scripts/main.js -->
<!--    <script src="scripts/main.js"></script>-->
    <!-- endbuild -->
    <script type="text/javascript"
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAnMbZDkO_5uB23-g0cWodU3KRz5BJwtPY">
    </script>


    <script type="text/javascript">
        var eids = new Bloodhound({
            datumTokenizer: Bloodhound.tokenizers.obj.whitespace,
            queryTokenizer: Bloodhound.tokenizers.whitespace,
            // url points to a json file that contains an array of country names, see
            // https://github.com/twitter/typeahead.js/blob/gh-pages/data/countries.json
             prefetch: '/api/eids'
               
        });

         // passing in `null` for the `options` arguments will result in the default
         // options being used
        $('#inpSearch').typeahead({
            hint: true,
            highlight: true,
            minLength: 1,

        }, {
            name: 'eid-data',
            display: 'firstName',
            source: eids
        });
        
        
        if($.cookie('token')){
            $("#liLogin").html('Logout');
            $("#liLogin").on('click',function(e){
                $.cookie('token',' ');
            });
                       
        }else{
            $("#liLogin").html('Login');
        }
        
        if (sessionStorage.getItem('eidData')){
            populateForm(JSON.parse(sessionStorage.getItem('eidData')));
        }
        
        function iIsRRNoValid(n) {
            // RR numbers need to be 11 chars long
            if (n.length != 11)
                return false;

            var checkDigit = n.substr(n.length - 2, 2);
            var modFunction = function(nr) { return 97 - (nr % 97); };
            var nrToCheck = parseInt(n.substr(0, 9));

            // first check without 2
            if (modFunction(nrToCheck) == checkDigit)
                return true;

            // then check with 2 appended for y2k+ births
            nrToCheck = parseInt('2' + n.substr(0, 9));

            return (modFunction(nrToCheck) == checkDigit);
        }
      
        
         var eidData = {};
        $("#btnReadId").on('click', function () {
            var openedWindow = window.open("https://www.idlog.be:9080/eid.html", "Eid-applet","width=800px,height=400px");
            window.addEventListener("message", function receiveMessage(event) {
                if (event.origin !== "http://www.idlog.be:9000/input"){
                    if (event.data) {
                        eidData = event.data;  
                        sessionStorage.setItem('eidData', JSON.stringify(eidData));
                        populateForm(event.data);
                    }
                }
            }, false);
        });
//        function getParameterByName(name) {
//            name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
//            var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
//                results = regex.exec(location.search);
//            return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
//        }
//        
//        var access_token = getParameterByName('access_token');
//        if (access_token){
//             document.cookie="token=" + access_token;
////            $.cookie('token',access_token);
//        }
        
        function populateForm(data){
            $('#firstName').val(data.firstName);
            $('#name').val(data.name);
            $('#middleName').val(data.middleName);
            $('#nationalNumber').val(data.nationalNumber);
            $('#dateOfBirth').val(data.dateOfBirth);
            $('#placeOfBirth').val(data.placeOfBirth);
            $('#nationality').val(data.nationality);
            $('#streetAndNumber').val(data.address.streetAndNumber);
            $('#zip').val(data.address.zip);
            $('#municipality').val(data.address.municipality);
            $('#cardNumber').val(data.cardNumber);
            $('#cardValidityDateBegin').val(data.cardValidityDateBegin);
            $('#cardValidityDateEnd').val(data.cardValidityDateEnd);
            $('#idPhoto').attr("src", data.photo);
        }
        
        function createData() {
           return eidData = {
                firstName: $('#firstName').val(),
                name : $('#name').val(),
                middleName : $('#middleName').val(),
                nationalNumber: $('#nationalNumber').val(),
                dateOfBirth: $('#dateOfBirth').val(),
                placeOfBirth: $('#placeOfBirth').val(),
                nationality:$('#nationality').val(),
                address: { 
                    streetAndNumber:$('#streetAndNumber').val(),
                    zip:$('#zip').val(),
                    municipality:$('#municipality').val()
                },
                cardNumber:$('#cardNumber').val(),
                cardValidityDateBegin:$('#cardValidityDateBegin').val(),
                cardValidityDateEnd:$('#cardValidityDateEnd').val(),
                photo: $('#idPhoto').attr('src')
            }
        }
        
        
        
        
        $("#eidForm").on('submit',function(event){
            event.preventDefault();
            if ( $("#eidForm").serialize()){
                $.ajax({
                   url: '/api/eids/',
//                   data:  JSON.stringify(eidData),
                   data:  JSON.stringify(createData()),
                    
                   beforeSend:function(xhr) {
                       if ($.cookie('token')) {
                          xhr.setRequestHeader('Authorization', 'Bearer ' + $.cookie('token'));
                        }
                    },
//                    headers: {'Authorization': 'Bearer ' + access_token},
                   error: function() {
                      
                   },
                   dataType: 'json',
                   contentType: 'application/json',
                   success: function(data) {
                      alert(data);
                   },
                   type: 'POST'
                });
                
                
            }else{
                
            }
        
        });

        

        (function(){
            var map;

            function initialize() {
              var mapOptions = {
                zoom: 6
              };
              map = new google.maps.Map(document.getElementById('map-canvas'),
                  mapOptions);
            }
            if (!navigator.geolocation){
//                output.innerHTML = "<p>Geolocation is not supported by your browser</p>";
                handleNoGeolocation(false);
                return;
              }else{
                  function success(position) {
                    var pos = new google.maps.LatLng(position.coords.latitude,
                                                   position.coords.longitude);

                      var infowindow = new google.maps.InfoWindow({
                        map: map,
                        position: pos,
                        content: 'Location found using HTML5.'
                      });

                      map.setCenter(pos);
                  };

                  function error() {
                    handleNoGeolocation(true);
                  };

                  

                  navigator.geolocation.getCurrentPosition(success, error);    

                  
              }
                
            

            function handleNoGeolocation(errorFlag) {
              if (errorFlag) {
                var content = 'Error: The Geolocation service failed.';
              } else {
                var content = 'Error: Your browser doesn\'t support geolocation.';
              }

              var options = {
                map: map,
                position: new google.maps.LatLng(60, 105),
                content: content
              };

              var infowindow = new google.maps.InfoWindow(options);
              map.setCenter(options.position);
            }

            google.maps.event.addDomListener(window, 'load', initialize)})();
    </script>

</body>

</html>